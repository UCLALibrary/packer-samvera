{
  "variables": {
    "aws_access_key": "",
    "aws_secret_key": "",
    "aws_region": "",
    "timezone": "",
    "hostname": "",
    "domain": "",
    "project_name": "",
    "project_owner": "",
    "project_version": "",
    "cap_deployment": "",
    "vagrant_cloud_token": "",
    "vagrant_cloud_user": "",
    "vagrant_version": "0.0.1-{{ timestamp }}",
    "ubuntu_version": "16.04",
    "vagrant_source_iso": "ubuntu-16.04.4-server-amd64.iso",
    "vagrant_source_iso_sha256_checksum": "0a03608988cfd2e50567990dc8be96fb3c501e198e2e6efcb846d89efc7b89f2",
    "aws_source_ami": "ubuntu/images/*ubuntu-xenial-16.04-amd64-server-*",
    "aws_ami_owner": "099720109477"
  },
  "builders": [
    {
      "type": "amazon-ebs",
      "access_key": "{{ user `aws_access_key` }}",
      "secret_key": "{{ user `aws_secret_key` }}",
      "region": "{{ user `aws_region` }}",
      "source_ami_filter": {
        "filters": {
          "virtualization-type": "hvm",
          "name": "{{ user `aws_source_ami` }}",
          "root-device-type": "ebs"
        },
        "owners": ["{{ user `aws_ami_owner` }}"],
        "most_recent": true
      },
      "force_deregister": true,
      "force_delete_snapshot": true,
      "instance_type": "t2.medium",
      "ssh_username": "ubuntu",
      "ami_name": "samvera-base {{ timestamp }}",
      "ami_description": "A base box for Samvera"
    },
    {
      "type": "virtualbox-ovf",
      "name": "vagrant",
      "source_path": "builds/virtualbox/samvera-base.ovf",
      "headless": true,
      "ssh_username": "vagrant",
      "ssh_password": "vagrant",
      "ssh_port": 22,
      "ssh_pty": true,
      "ssh_wait_timeout": "10000s",
      "shutdown_command": "echo 'vagrant' | sudo -S shutdown -P now",
      "vm_name": "samvera-hyrax",
      "guest_additions_mode": "disable",
      "vboxmanage": [
        [ "modifyvm", "{{ .Name }}", "--memory", "2048" ],
        [ "modifyvm", "{{ .Name }}", "--cpus", "2" ]
      ]
    },
    {
      "type": "virtualbox-ovf",
      "name": "vagrant-deploy",
      "source_path": "builds/virtualbox/samvera-base.ovf",
      "headless": true,
      "ssh_username": "vagrant",
      "ssh_password": "vagrant",
      "ssh_port": 22,
      "ssh_pty": true,
      "ssh_wait_timeout": "10000s",
      "shutdown_command": "echo 'vagrant' | sudo -S shutdown -P now",
      "vm_name": "samvera-hyrax",
      "vboxmanage": [
        [ "modifyvm", "{{ .Name }}", "--memory", "2048" ],
        [ "modifyvm", "{{ .Name }}", "--cpus", "2" ]
      ]
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "only": [ "vagrant", "vagrant-deploy" ],
      "execute_command": "echo 'vagrant' | {{ .Vars }} /usr/bin/sudo -S -E bash '{{ .Path }}'",
      "script": "scripts/setup-hyrax.sh",
      "environment_vars": [
        "SECRET_KEY_BASE=asdf",
        "DB_USERNAME={{ user `samvera_db_user` }}",
        "DB_PASSWORD={{ user `samvera_db_password` }}",
        "DB_NAME={{ user `project_name` }}",
        "PROJECT_OWNER={{ user `project_owner` }}",
        "PROJECT_NAME={{ user `project_name` }}",
        "GITHUB_BRANCH={{ user `project_version` }}"
      ]
    },
    {
      "type": "ansible-local",
      "only": [ "vagrant", "vagrant-deploy" ],
      "playbook_file": "ansible/playbooks/samvera-hyrax.yml",
      "galaxy_file": "ansible/requirements/main.yml",
      "extra_arguments": [
        "-e \" samvera_db_user={{ user `samvera_db_user` }} samvera_db_password={{ user `samvera_db_password` }}\"",
        "-e \"root_db_password={{ user `root_db_password` }} timezone={{ user `timezone` }} hostname={{ user `hostname` }}\"",
        "-e \"domain={{ user `domain` }} project_name={{ user `project_name` }} project_owner={{ user `project_owner` }}\"",
        "-e \"cap_deployment={{ user `cap_deployment` }} project_version={{ user `project_version` }}\"",
        "-e \"ansible_sudo_pass=vagrant\""
      ]
    },
    {
      "type": "ansible-local",
      "only": [ "amazon-ebs" ],
      "playbook_file": "ansible/playbooks/samvera-hyrax.yml",
      "galaxy_file": "ansible/requirements/main.yml",
      "extra_arguments": [
        "-e \"samvera_db_user={{ user `samvera_db_user` }} samvera_db_password={{ user `samvera_db_password` }}\"",
        "-e \"root_db_password={{ user `root_db_password` }} timezone={{ user `timezone` }} hostname={{ user `hostname` }}\"",
        "-e \"domain={{ user `domain` }} project_name={{ user `project_name` }} project_owner={{ user `project_owner` }}\"",
        "-e \"cap_deployment={{ user `cap_deployment` }} project_version={{ user `project_version` }}\""
      ]
    },
    {
      "type": "shell",
      "only": [ "vagrant", "vagrant-deploy" ],
      "execute_command": "echo 'vagrant' | {{ .Vars }} /usr/bin/sudo -S -E bash '{{ .Path }}'",
      "script": "scripts/cleanup.sh"
    },
    {
      "type": "shell",
      "only": [ "amazon-ebs" ],
      "execute_command": "echo '{{ user `ssh-password` }}' | {{ .Vars }} /usr/bin/sudo -S -E bash '{{ .Path }}'",
      "script": "scripts/cleanup.sh"
    }
  ],
  "post-processors": [
    [{
      "type": "vagrant",
      "only": [ "vagrant", "vagrant-deploy" ],
      "output": "builds/vagrant/samvera-hyrax.box",
      "vagrantfile_template": "vagrant/hyrax/Vagrantfile"
    },
    {
      "type": "vagrant-cloud",
      "only": [ "vagrant-deploy" ],
      "box_tag": "{{ user `vagrant_cloud_user` }}/samvera-hyrax",
      "access_token": "{{ user `vagrant_cloud_token` }}",
      "version": "{{ user `vagrant_version` }}"
    }]
  ]
}
